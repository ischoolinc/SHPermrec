# 高中新生名冊調整 0822 - Todo 清單

## 專案資訊
- **專案名稱**: SHPermrec\UpdateRecordModule_SH_D\UpdateRecordModule
- **檔案路徑**: `Resources\EnrollmentListTemplate.xlsx`
- **記錄日期**: 2025年8月22日
- **狀態**: 待處理

---

## Todo 1: 修正 EnrollmentList2021.cs 第520-532行計算錯誤風險

### 問題描述
`EnrollmentList2021.cs` 第520至532行存在嚴重的計算邏輯錯誤風險，主要問題是變數 `extra` 被重複使用，導致計算結果不正確。

### 問題位置
- **檔案**: `GovernmentalDocument/Reports/List/EnrollmentList2021.cs`
- **行數**: 第520-532行
- **函數**: `Build` 方法內

### 具體問題分析

#### 1. 變數重用風險
```csharp
// 第520-525行：計算外加學生總數
int extra = 0;
if (int.TryParse(extraStudent1, out in_temp)) extra += in_temp;
if (int.TryParse(extraStudent2, out in_temp)) extra += in_temp;
if (int.TryParse(extraStudent3, out in_temp)) extra += in_temp;

// 第526行：計算一般生人數（這個計算邏輯是錯誤的）
generalStudentCount = actualStudentCount - extra;

// 第527-530行：重新計算超收學生數（覆蓋了外加學生總數，且公式錯誤）
extra = generalStudentCount - (approvedClassCount * approvedStudentCount);
```

**正確的計算邏輯應該是**：
```csharp
// 正確公式：實招新生數 - 外加錄取原住民 - 外加錄取身心障礙生 - 外加錄取其他 - 核定班數 × 核定學生數
overEnrollment = actualStudentCount - extraStudents - (approvedClassCount * approvedStudentCount);
```

#### 2. 邏輯錯誤
- **第520-525行**: `extra` 變數代表「外加學生總數」
- **第526行**: 錯誤地計算「一般生人數」（這個概念在正確公式中不需要）
- **第527-530行**: `extra` 變數被重新賦值為「超收學生數」，且使用錯誤的計算公式
- **結果**: 變數含義不一致，邏輯混亂，計算公式錯誤

#### 3. 計算公式錯誤
- **原始錯誤公式**: 先計算一般生人數，再用一般生人數減去核定容量
- **正確公式**: 實招新生數 - 外加錄取原住民 - 外加錄取身心障礙生 - 外加錄取其他 - 核定班數 × 核定學生數
- **差異**: 不需要先計算一般生人數，直接從實招新生數中減去所有項目即可

#### 3. 資料不一致
- 最終填入 Excel 的 `extra` 值與原始外加學生概念不符
- 可能導致報表資料錯誤

### 影響範圍
- **新生名冊統計表**: 外加學生數和超收學生數可能計算錯誤
- **資料完整性**: 影響政府報表的準確性
- **維護性**: 程式碼難以理解和維護

### 修正目標
1. 使用不同的變數名稱區分不同概念
2. **修正計算公式為正確邏輯**：實招新生數 - 外加錄取原住民 - 外加錄取身心障礙生 - 外加錄取其他 - 核定班數 × 核定學生數
3. 移除不必要的「一般生人數」計算步驟
4. 確保計算邏輯清晰正確
5. 提高程式碼可讀性和維護性
6. 避免資料計算錯誤

### 建議修正方案
```csharp
// 建議的修正版本
int extraStudents = 0;        // 外加學生總數
int overEnrollment = 0;      // 超收學生數

// 計算外加學生總數
if (int.TryParse(extraStudent1, out in_temp)) extraStudents += in_temp;
if (int.TryParse(extraStudent2, out in_temp)) extraStudents += in_temp;
if (int.TryParse(extraStudent3, out in_temp)) extraStudents += in_temp;

// 直接計算超收學生數（使用正確公式）
if (int.TryParse(actualStudentCount, out in_temp) && 
    int.TryParse(approvedClassCount, out int approvedClass) && 
    int.TryParse(approvedStudentCount, out int approvedStudent))
{
    // 正確公式：實招新生數 - 外加錄取原住民 - 外加錄取身心障礙生 - 外加錄取其他 - 核定班數 × 核定學生數
    overEnrollment = in_temp - extraStudents - (approvedClass * approvedStudent);
}

// 確保超收數不為負數
if (overEnrollment < 0) overEnrollment = 0;

// 填入 Excel 時使用正確的變數
StaticSheet.Cells[cover_row_counter, 5].PutValue(extraStudent1);      // 外加錄取原住民
StaticSheet.Cells[cover_row_counter, 6].PutValue(extraStudent2);      // 外加錄取身心障礙生
StaticSheet.Cells[cover_row_counter, 7].PutValue(extraStudent3);      // 外加錄取其他
StaticSheet.Cells[cover_row_counter, 8].PutValue(overEnrollment);     // 超收學生數
```

### 優先級
- **等級**: 🔴 高優先級
- **原因**: 涉及資料計算錯誤，可能影響政府報表準確性
- **建議**: 盡快修正，避免產生錯誤的報表資料

### 測試建議
1. **單元測試**: 建立測試案例驗證新的計算公式邏輯
2. **計算驗證**: 特別驗證「實招新生數 - 外加錄取原住民 - 外加錄取身心障礙生 - 外加錄取其他 - 核定班數 × 核定學生數」的計算結果
3. **整合測試**: 測試完整的新生名冊產生流程
4. **資料驗證**: 確認 Excel 輸出資料的正確性，特別是超收學生數欄位
5. **回歸測試**: 確保修正後不影響其他功能
6. **邊界測試**: 測試各種數值組合，確保計算結果正確

### 注意事項
- 修正前請先備份原始程式碼
- 修正後需要進行充分的測試
- 建議在測試環境中先驗證修正效果
- 記錄修正過程和測試結果

---

## Todo 2: [待新增]

---

## 完成狀態追蹤
- [x] Todo 1: 修正 EnrollmentList2021.cs 計算錯誤風險 ✅ **已完成**
- [ ] Todo 2: [待新增]

### 更新記錄
| 日期 | 更新內容 | 更新者 |
|------|----------|--------|
| 2025-08-22 | 建立 Todo 清單，記錄計算錯誤風險問題 | 系統分析師 |
| 2025-08-22 | 實作 Todo 1，修正計算錯誤風險，完成程式碼修改 | 系統分析師 |
