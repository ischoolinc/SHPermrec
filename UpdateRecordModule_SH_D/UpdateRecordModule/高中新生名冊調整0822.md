# 高中新生名冊調整 0822

## 專案概述
- **專案名稱**: SHPermrec\UpdateRecordModule_SH_D\UpdateRecordModule
- **檔案路徑**: `Resources\EnrollmentListTemplate.xlsx`
- **記錄日期**: 2025年8月22日

## 使用 EnrollmentListTemplate.xlsx 的程式清單

### 1. 報表產生器類別 (Report Builder Classes)

#### EnrollmentList.cs
- **位置**: `GovernmentalDocument/Reports/List/EnrollmentList.cs`
- **用途**: 新生名冊報表產生器
- **功能**: 產生新生名冊的 Excel 報表
- **使用方式**: 作為 Excel 模板，複製樣式和欄寬設定
- **關鍵程式碼**:
  ```csharp
  //從 Resources 將新生名冊template讀出來
  Workbook template = new Workbook();
  template.Open(new MemoryStream(Properties.Resources.EnrollmentListTemplate));
  
  //產生 excel
  Workbook wb = new Aspose.Cells.Workbook();
  wb.Open(new MemoryStream(Properties.Resources.EnrollmentListTemplate));
  ```

#### EnrollmentList2021.cs
- **位置**: `GovernmentalDocument/Reports/List/EnrollmentList2021.cs`
- **用途**: 2021版新生名冊報表產生器
- **功能**: 產生 2021 版新生名冊的 Excel 報表
- **使用方式**: 同樣作為 Excel 模板，但指定了 `FileFormatType.Xlsx` 格式
- **關鍵程式碼**:
  ```csharp
  //從 Resources 將新生名冊template讀出來
  Workbook template = new Workbook();
  template.Open(new MemoryStream(Properties.Resources.EnrollmentListTemplate),FileFormatType.Xlsx);
  
  //產生 excel
  Workbook wb = new Aspose.Cells.Workbook();
  wb.Open(new MemoryStream(Properties.Resources.EnrollmentListTemplate), FileFormatType.Xlsx);
  ```

**第501-520行資料來源分析**:
- **資料來源**: XML 節點 `異動名冊封面` 的屬性值
- **具體資料項目**:
  - `@上傳類別` → `updateType`
  - `@實招新生數` → `actualStudentCount`
  - `@核定班數` → `approvedClassCount`
  - `@核定學生數` → `approvedStudentCount`
  - `@外加錄取原住民` → `extraStudent1`
  - `@外加錄取身心障礙生` → `extraStudent2`
  - `@外加錄取其他` → `extraStudent3`
  - `@建教班僑生數` → `extraStudent4`
- **計算邏輯**:
  - 一般生數 = 實招新生數 - (外加錄取原住民 + 外加錄取身心障礙生 + 外加錄取其他)
  - 超收學生數 = 一般生數 - (核定班數 × 核定學生數)
  - 日夜部判斷: 學校代碼為數字則為"日間部"，否則為"夜間部"

**第520-532行計算邏輯詳細分析**:
```csharp
// 變數初始化
int in_temp = 0;        // 臨時整數變數，用於 TryParse
int extra = 0;          // 外加學生總數
int generalStudentCount = 0;  // 一般生人數

// 計算外加學生總數 (第520-525行)
if (int.TryParse(extraStudent1, out in_temp))      // 外加錄取原住民
    extra += in_temp;
if (int.TryParse(extraStudent2, out in_temp))      // 外加錄取身心障礙生
    extra += in_temp;
if (int.TryParse(extraStudent3, out in_temp))      // 外加錄取其他
    extra += in_temp;

// 計算一般生人數 (第526行)
if (int.TryParse(actualStudentCount, out in_temp))
    generalStudentCount = in_temp - extra;          // 一般生 = 實招新生數 - 外加學生總數

// 重新計算超收學生數 (第527-530行)
if (int.TryParse(approvedClassCount, out in_temp) && int.TryParse(approvedStudentCount, out in_temp))
    extra = generalStudentCount - int.Parse(approvedClassCount) * int.Parse(approvedStudentCount);
                                                                    // 超收數 = 一般生數 - (核定班數 × 核定學生數)

// 確保超收數不為負數 (第531行)
if (extra < 0)
    extra = 0;
```

**計算流程說明**:
1. **外加學生計算**: 將三種外加錄取人數相加
2. **一般生計算**: 實招新生數減去外加學生總數
3. **超收學生重新計算**: 一般生數減去核定容量
4. **負數保護**: 確保超收數不會小於0

**⚠️ 第520-532行計算錯誤風險分析**:

#### 1. 變數重用風險
- **問題**: 變數 `extra` 被重複使用，先計算外加學生總數，後重新計算為超收學生數
- **風險**: 邏輯混亂，容易造成計算錯誤
- **建議**: 使用不同變數名稱，如 `extraStudents` 和 `overEnrollment`

#### 2. 計算順序問題
```csharp
// 第520-525行：計算外加學生總數
extra = extraStudent1 + extraStudent2 + extraStudent3;

// 第526行：計算一般生人數
generalStudentCount = actualStudentCount - extra;

// 第527-530行：重新計算超收學生數（覆蓋了外加學生總數）
extra = generalStudentCount - (approvedClassCount * approvedStudentCount);
```

#### 3. 潛在錯誤
- **邏輯錯誤**: 第527行後，`extra` 變數的含義從「外加學生總數」變成「超收學生數」
- **資料不一致**: 最終填入 Excel 的 `extra` 值與原始外加學生概念不符
- **維護困難**: 變數重用導致程式碼難以理解和維護

#### 4. 建議修正方案
```csharp
// 建議的修正版本
int extraStudents = 0;        // 外加學生總數
int overEnrollment = 0;      // 超收學生數
int generalStudentCount = 0; // 一般生人數

// 計算外加學生總數
if (int.TryParse(extraStudent1, out in_temp)) extraStudents += in_temp;
if (int.TryParse(extraStudent2, out in_temp)) extraStudents += in_temp;
if (int.TryParse(extraStudent3, out in_temp)) extraStudents += in_temp;

// 計算一般生人數
if (int.TryParse(actualStudentCount, out in_temp))
    generalStudentCount = in_temp - extraStudents;

// 計算超收學生數
if (int.TryParse(approvedClassCount, out in_temp) && int.TryParse(approvedStudentCount, out in_temp))
    overEnrollment = generalStudentCount - (in_temp * int.Parse(approvedStudentCount));

// 確保超收數不為負數
if (overEnrollment < 0) overEnrollment = 0;

// 填入 Excel 時使用正確的變數
StaticSheet.Cells[cover_row_counter, 5].PutValue(extraStudent1);  // 外加錄取原住民
StaticSheet.Cells[cover_row_counter, 6].PutValue(extraStudent2);  // 外加錄取身心障礙生
StaticSheet.Cells[cover_row_counter, 7].PutValue(extraStudent3);  // 外加錄取其他
StaticSheet.Cells[cover_row_counter, 8].PutValue(overEnrollment); // 超收學生數
```

### 2. 報表選擇器 (Report Selector)

#### ReportSelector.cs
- **位置**: `BL/ReportSelector.cs`
- **用途**: 報表選擇器
- **功能**: 根據名冊類型選擇對應的報表產生器
- **相關邏輯**:
  - 當 `UpdateType` 為 "新生名冊" 時，使用 `EnrollmentList`
  - 當 `UpdateType` 為 "新生名冊_2021版" 時，使用 `EnrollmentList2021`

### 3. 表單介面 (Form Interfaces)

#### EnrollmentListModifyingCoverForm.cs
- **位置**: `GovernmentalDocument/EnrollmentListModifyingCoverForm.cs`
- **用途**: 新生名冊修改封面表單

#### EnrollmentListModifyingCoverForm2021.cs
- **位置**: `GovernmentalDocument/EnrollmentListModifyingCoverForm2021.cs`
- **用途**: 2021版新生名冊修改封面表單

#### ListForm.cs
- **位置**: `GovernmentalDocument/ListForm.cs`
- **用途**: 主要清單表單
- **功能**: 會根據選擇建立對應的表單

### 4. 資源管理

#### Properties/Resources.resx
- **用途**: 資源定義檔
- **內容**: 定義 `EnrollmentListTemplate` 資源

#### Properties/Resources.Designer.cs
- **用途**: 自動產生的資源存取程式碼
- **功能**: 提供 `Properties.Resources.EnrollmentListTemplate` 屬性存取

## 系統架構

```
EnrollmentListTemplate.xlsx (Excel 模板)
           ↓
    Properties.Resources
           ↓
    ReportSelector (報表選擇器)
           ↓
    ┌─────────────────┬─────────────────┐
    │   EnrollmentList│ EnrollmentList  │
    │   (標準版)      │   2021版        │
    └─────────────────┴─────────────────┘
           ↓
    Excel 報表輸出
```

## 主要功能

1. **模板複製**: 從資源中讀取 Excel 模板，複製樣式和欄寬設定
2. **資料填入**: 將 XML 資料填入至 Excel 中
3. **格式保持**: 保持政府規定的新生名冊格式
4. **版本支援**: 支援標準版和 2021 版兩種格式

## 注意事項

- 模板檔案位於 `Resources\EnrollmentListTemplate.xlsx`
- 系統支援兩種版本的新生名冊格式
- 使用 Aspose.Cells 套件處理 Excel 檔案
- 報表產生器繼承自 `ReportBuilder` 基底類別

## 相關檔案

- `Resources\EnrollmentListTemplate.xlsx` - Excel 模板檔案
- `GovernmentalDocument\Reports\List\EnrollmentList.cs` - 標準版報表產生器
- `GovernmentalDocument\Reports\List\EnrollmentList2021.cs` - 2021版報表產生器
- `BL\ReportSelector.cs` - 報表選擇器
- `GovernmentalDocument\ListForm.cs` - 主要清單表單
